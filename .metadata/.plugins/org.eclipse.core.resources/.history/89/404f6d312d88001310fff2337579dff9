package controller;

import java.io.BufferedInputStream;
import java.io.BufferedReader;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.ObjectInput;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.io.PrintWriter;
import java.net.ServerSocket;
import java.net.Socket;

import javax.swing.JApplet;
import javax.swing.event.EventListenerList;

import subscribers.MainControllerSubscriber;
import model.CurrentModel;

public class ServerController 
{
	private static EventListenerList subscriberList = new EventListenerList();
	
	private static JApplet application;
	
	private static CurrentModel CM;
	
	private static String currentTool;
	
	private static ServerSocket serverSocket;
	private static Socket socket;
    private static int serverPort = 65000;

    private static PrintWriter outToClient;
    private static BufferedReader inFromClient;
    private static ObjectOutputStream oos;
    private static ObjectInputStream ois;
    
    private static String modelPath;
   	
    public static void initializeServer()
    {
	    try 
	    {
	    	try 
	    	{
				ServerController.setServerSocket(new ServerSocket(ServerController.getServerPort()));
			} 
	    	catch (Exception e1) 
	    	{
				System.err.println("Failure creating server socket!");
				e1.printStackTrace();
				return;
			}
	    	
	        System.out.println("TrackingGUIServer listening on port: " + ServerController.getServerPort());
	        
	    	
	    	System.out.println("Initializing socket...");
	    	System.out.println("Waiting for request from applet...");
	        socket = serverSocket.accept();
	        
	        if(socket.getRemoteSocketAddress().toString().equals("127.0.0.1"))
	        {
	        	modelPath = "C:/Users/Brian Grosskleg/Desktop/model.ser";
	        }
	        else if(socket.getRemoteSocketAddress().toString().equals("172.16.1.85"))
	        {
	        	modelPath = "var/www/model.ser";
	        }
	        else
	        {
	        	System.err.println("Could not set model path.");
	        	return;
	        }
	        CM = loadModelfromFile();
	        
	        outToClient = new PrintWriter(socket.getOutputStream(), true);
	        inFromClient = new BufferedReader(new InputStreamReader(socket.getInputStream()));
	        oos = new ObjectOutputStream(socket.getOutputStream());
	        ois = new ObjectInputStream(socket.getInputStream());
	        System.out.println("Initializing socket complete.");
	    } 
	    catch (java.io.IOException e) 
	    {
	        System.err.println("Could not initialize socket.");
	    }   
    }
    
		
    //REFERENCE TO APPLICATION***********************************
	public static JApplet getApplication() {
		return application;
	}

	public static void setApplication(JApplet application) {
		ServerController.application = application;
	}
	
	
	//CURRENT MODEL**********************************************
	public static CurrentModel getCM() {
		return CM;
	}

	public static void setCM(CurrentModel cM) 
	{
		CM = cM;
		//CM.currentModelChanged();
	}
	
	
	
	//CURRENT TOOL***********************************************
	public static String getCurrentTool() {
		return currentTool;
	}

	public static void setCurrentTool(String currentTool) {
		ServerController.currentTool = currentTool;
		serverControllerChanged();
	}
	
	
	
	//NETWORKING PARAMETERS*******************************************************
	
	//Server port number
	public static int getServerPort() {
		return serverPort;
	}

	//Socket and ServerSocket
	public static Socket getSocket() {
		return socket;
	}
	
	public static void setServerSocket(ServerSocket ss){
		ServerController.serverSocket = ss;
	}

	public static void setSocket(Socket socket) {
		ServerController.socket = socket;
		serverControllerChanged();
	}			
	
	//Input/output TCP Streams
	public static PrintWriter getOutToClient() {
		return outToClient;
	}

	public static BufferedReader getInFromClient() {
		return inFromClient;
	}
	
	public static ObjectOutputStream getOOS() {
		return oos;
	}

	public static ObjectInputStream getOIS() {
		return ois;
	}
	
	//Model path
	public static String getModelPath() {
		return ServerController.modelPath;
	}
	
	
	
	//MODEL HANDLING*********************************************
	
	public static void saveModeltoDisk()
    {
		FileOutputStream fos = null;
		ObjectOutputStream oos = null;
		
    	try 
    	{
    		fos = new FileOutputStream(modelPath);
    		oos = new ObjectOutputStream(fos);
    		oos.writeObject(ServerController.getCM());
    		oos.close();
    		fos.close();
    		System.out.println("Model saved to file!");
    	} 
    	catch (Exception e1) 
    	{
    		try
    		{
	    		if(fos != null)
	    		{
	    			fos.close();
	    		}
	    		if(oos != null)
	    		{
	    			oos.close();
	    		}
	    		System.out.println("Existing file stream closed.");
				} catch (Exception e) {
				System.out.println("Failure closeing file stream");
				e.printStackTrace();
		}
    		System.out.println("Model not saved to file!");
    		e1.printStackTrace();
    	}	
    }
	
    private static CurrentModel loadModelfromFile() 
    {
        //De-serialize the model
        try 
        {
        	InputStream fileStream = new FileInputStream(modelPath);
            InputStream buffer = new BufferedInputStream(fileStream);
            ObjectInput input = new ObjectInputStream (buffer);
			CurrentModel result = (CurrentModel)input.readObject();
			input.close();
			System.out.println("Model loaded from file!");
			return result;
		} 
        catch (Exception e1) 
        {
        	System.out.println("Model not loaded from file!");
			System.out.println("New model created.");
			return new CurrentModel();
		}
	}
    
    
   

	//SUBSCRIBERS************************************************

	


	//Add subscribers
	public static void addMainControllerSubscriber(MainControllerSubscriber subscriber)
	{
		subscriberList.add(MainControllerSubscriber.class, subscriber);
	}

	//Remove subscriber
	public static void removeMainControllerSubscriber(MainControllerSubscriber subscriber)
	{
		subscriberList.remove(MainControllerSubscriber.class, subscriber);
	}

	public static void serverControllerChanged()
	{
		//Notify Listeners
		Object[] subscribers = subscriberList.getListenerList();
		for (int i = 0; i < subscribers.length; i = i+2) {
			if (subscribers[i] == MainControllerSubscriber.class) {
				((MainControllerSubscriber) subscribers[i+1]).mainControllerChanged();
			}
		}
	}	
}
